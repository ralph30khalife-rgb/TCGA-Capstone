---
title: "General-Pipeline"
author: "Ralph Khalife"
date: "2025-11-24"
output: html_document
---

```{r}
# ---- Setup ----
library(TCGAbiolinks)
library(SummarizedExperiment)
library(dplyr)
library(edgeR)
library(ggplot2)
library(survival)
library(survminer)

dir.create("figs", showWarnings = FALSE)
dir.create("results", showWarnings = FALSE)

# ---- Configure Cancer Type Here ----
project_id <- "TCGA-READ"     # <<<<<<<< CHANGE THIS ONLY EACH TIME

# ---- Gene ID (PODXL) ----
podxl_id <- "ENSG00000128567"

```

```{r}
# ---- Step 1: Download data for one TCGA project ----

query <- GDCquery(
  project = project_id,
  data.category = "Transcriptome Profiling",
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts"
)

GDCdownload(query)
se <- GDCprepare(query)
```

```{r}
# ---- Step 2: Extract PODXL expression + normalize ----

expr  <- assay(se)
meta  <- as.data.frame(colData(se))

# robust match for PODXL row (handles version suffix)
podxl_row <- grep(paste0("^", podxl_id), rownames(expr), value = TRUE)[1]

PODXL_counts <- expr[podxl_row, ]

# Normalization
dge <- DGEList(counts = expr)
dge <- calcNormFactors(dge)
logcpm <- cpm(dge, log = TRUE, prior.count = 1)

PODXL_logcpm <- logcpm[podxl_row, ]

# standardize sample barcodes
meta$barcode_short <- substr(meta$barcode, 1, 12)

# final expression table
df_podxl <- data.frame(
  barcode    = meta$barcode_short,
  SampleType = meta$sample_type,
  RawCount   = as.numeric(PODXL_counts),
  logCPM     = as.numeric(PODXL_logcpm)
)

head(df_podxl)

```
```{r}
# ---- Step 3: Expression: tumor vs normal ----

p_box <- ggplot(df_podxl, aes(x = SampleType, y = logCPM, fill = SampleType)) +
  geom_boxplot() +
  theme_bw() +
  labs(
    title = paste("PODXL Expression in", project_id, "(log2-CPM)"),
    x = "",
    y = "log2(CPM)"
  ) +
  theme(legend.position = "none")

p_box

ggsave(paste0("figs/PODXL_", project_id, "_Boxplot.png"),
       p_box, width = 6, height = 4)

summary_podxl <- df_podxl %>%
  group_by(SampleType) %>%
  summarise(
    n = n(),
    mean_logCPM = mean(logCPM, na.rm = TRUE),
    median_logCPM = median(logCPM, na.rm = TRUE),
    sd_logCPM = sd(logCPM, na.rm = TRUE)
  )

write.csv(summary_podxl,
          paste0("results/PODXL_", project_id, "_ExpressionSummary.csv"),
          row.names = FALSE)

```

```{r}
# ---- Step 4: Clinical data + merge ----

clinical <- GDCquery_clinic(project_id, type = "clinical")

clinical_clean <- clinical %>%
  select(bcr_patient_barcode, vital_status,
         days_to_death, days_to_last_follow_up) %>%
  mutate(
    time = ifelse(!is.na(days_to_death), days_to_death, days_to_last_follow_up),
    status = ifelse(vital_status == "Dead", 1, 0)
  ) %>%
  filter(!is.na(time))

# merge survival + expression
surv_df <- merge(
  df_podxl[, c("barcode", "logCPM")],
  clinical_clean,
  by.x = "barcode", by.y = "bcr_patient_barcode"
)

surv_df <- surv_df[!duplicated(surv_df$barcode), ]

# define high/low
cutoff <- median(surv_df$logCPM, na.rm = TRUE)
surv_df$Group <- ifelse(surv_df$logCPM > cutoff, "High", "Low")

# KM plot
fit <- survfit(Surv(time, status) ~ Group, data = surv_df)

km_plot <- ggsurvplot(
  fit, data = surv_df,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, risk.table.col = "strata",
  palette = c("#E7B800", "#2E9FDF"),
  title = paste("KM Survival Curve for PODXL in", project_id),
  xlab = "Days", ylab = "Overall Survival Probability",
  surv.median.line = "hv"
)

ggsave(paste0("figs/PODXL_", project_id, "_KMcurve.png"),
       km_plot$plot, width = 6, height = 5)
```

```{r}
# ---- Step 5: Cox regression output ----

cox <- coxph(Surv(time, status) ~ logCPM, data = surv_df)
cox_sum <- summary(cox)

cox_output <- data.frame(
  Cancer = project_id,
  Gene = "PODXL",
  HR = cox_sum$coefficients[, "exp(coef)"],
  HR_lower95 = cox_sum$conf.int[, "lower .95"],
  HR_upper95 = cox_sum$conf.int[, "upper .95"],
  p_value = cox_sum$coefficients[, "Pr(>|z|)"],
  z_score = cox_sum$coefficients[, "z"]
)

write.csv(cox_output,
          paste0("results/PODXL_", project_id, "_Cox.csv"),
          row.names = FALSE)

cox_output

```


